# Использование Docker

![docker_ros](../.imgs/docker_ros.png)
<p align="center">
    <strong>Источник: </strong> https://roboticseabass.com/2021/04/21/docker-and-ros/
</p>

При установке и портировании пакетов между разными машинами часто возникают проблемы. Даже ROS иногда имеет проблемы с установкой и настройкой. ROS может не работать на вашей операционной системе (ОС) или вообще может быть с ней несовместим. При этом использование виртуальных машин поверх текущей ОС (гипервизоров второго типа) не позволяет эффективно использовать железо компьютера. Помимо этого, остро стоит вопрос с доставкой вашего кода на борт робота или БЛА. Для опытного образца всегда можно загрузить и собрать код вручную, при этом даже такой вариант может отнять много времени и сил. А что делать, если аппаратов 100 и, помимо вашего ПО, на бортовом компьютере должны присутствовать другие программы, несовместимые с вашим окружением? В таком случае часто используют контейнеры и пакеты. Наибольшую популярность получили системы **docker и snap**. В материале ниже покажем, как можно использовать docker container для разработки с использованием ROS.

## Что такое docker?

**Docker** — это платформа, которая использует технологию виртуализации на уровне ОС для автоматизированного развёртывания ПО в так называемых контейнерах.


Виртуализация на уровне ОС означает, что Docker использует ресурсы хост-системы (ОС, на которой запущен Docker) для работы контейнеров. Каждый контейнер считается изолированным процессом в пользовательском пространстве хост-системы. Это ключевое отличие от традиционной виртуализации, где каждая виртуальная машина имеет собственную ОС, что требует существенно большего количества ресурсов ОС.


`Контейнеры Docker`  — это мини-версии ОС(очень упрощенно), которые содержат только то, что необходимо для работы конкретного приложения. Например, исходный код программ, библиотеки, системные инструменты и другие зависимости. В отличие от виртуальных машин, которые имеют собственную полноценную ОС, контейнеры Docker используют ядро ОС ПК. Благодаря этому контейнеры Docker становятся очень лёгкими и быстрыми по сравнению с традиционными виртуальными машинами.


**Docker** может работать на различных платформах, включая **Linux**, **Windows** и **macOS**. Однако важно отметить, что Docker на Windows и macOS работает немного иначе, чем на Linux. В Windows и macOS Docker использует лёгкую виртуальную машину для запуска Docker Engine, потому что Docker был изначально разработан для Linux и использует функции ядра Linux. Несмотря на это, пользовательский опыт остаётся практически одинаковым на всех платформах.


В общем, Docker - это мощный инструмент для создания, развертывания и управления приложениями,
который обеспечивает консистентность между разработкой и производством,
упрощает управление зависимостями и улучшает эффективность использования ресурсов.

## Установка docker

### Linux

Откройте терминал и выполните команды, которые установят Docker:

```bash
curl -fsSL https://get.docker.com | sh
```

```bash
sudo usermod -aG docker $USER
```

```bash
sudo systemctl disable --now docker.service docker.socket
```

```bash
sudo apt-get install -y uidmap
```

```bash
dockerd-rootless-setuptool.sh install --force
```

Docker desktop устанавливать не нужно, могут возникнуть проблемы с настройкой доступа контейнера к ресурсам экрана.


### MacOS

Скачайте Docker Desktop для Mac
с официального сайта Docker [здесь](https://docs.docker.com/desktop/install/mac-install/).
Дважды щелкните Docker.dmg, чтобы открыть установщик, затем перетащите иконку Docker в папку "Программы".

Дважды щелкните Docker.app в папке "Программы", чтобы запустить Docker.

В меню Docker отобразится окно Соглашения об услугах подписки Docker.
Выберите "Принять", чтобы продолжить. Docker Desktop начнет работу после того, как вы примете условия.

### Windows

Скачайте установщик Docker Desktop
с официального сайта Docker [здесь](https://docs.docker.com/desktop/install/windows-install/).

Запустите установщик Docker Desktop Installer.exe двойным кликом.
Следуйте инструкциям мастера установки, чтобы авторизовать установщик и продолжить установку.

После успешной установки нажмите "Закрыть", чтобы завершить процесс установки.

## Cборка контейнера

Для использования контейнера его необходимо получить либо выполнить сборку контейнера в ручную.
Правила сборки контейнера описываются файлом под названием `Dockerfile`

`Dockerfile` - это текстовый файл, содержащий набор инструкций,
которые Docker может выполнить для создания образа контейнера.
Этот образ затем может быть использован для создания и запуска контейнеров Docker.
Dockerfile обычно включает в себя инструкции по установке и настройке операционной системы,
установке необходимого программного обеспечения и зависимостей,
а также настройке среды выполнения для вашего приложения.

Выполним сборку контейнера из дериктории содержащей Dockerfile
```bash
docker build -t <container_name> .
```

Назовем контейнер `px4_sim` 

```bash
docker build -t px4_sim .
```

По завершению установки должны появиться следующие строки.

![docker_build_success](../.imgs/docker_build_success.png)
<p align="center">
    <strong>Здесь и далее источник: </strong> Михаил Колодочка
</p>

## Запуск контейнера

Запустим наш контейнер при помощи команды

```bash
docker run -it --rm px4_sim 
```

В консоли должны появиться следующие строки:

![docker_run_out](../.imgs/docker_run_out.png)

При этом: 
* --rm - означает удаление контейнера после остановки 
* -it - значит интерактивное исполнение,
то есть все что будет происходить в консоли контейнера будет отображаться в терминале. В нашем случае это команда
`top -b`, которая была задана в качестве стартовой в Dockerfile.

Теперь откроем другой терминал и попробуем подключится к запущенному контейнеру при помощи команды `exec`.

```bash
docker exec -it <container_id\name> bash
```
container_id можно узнать командой:

```bash
docker ps
```

После подключения к контейнеру мы выполнили команду bash, поэтому оказываемся в консоли. Тут можно выполнить команду roscore или любую другую. Однако если мы попробуем запустить приложение с графическим интерфейсом (скажем, пример с черепахой `rosrun turtlesim turtlesim_node`), то увидим следующую ошибку:



![docker_error_xcb](../.imgs/docker_error_xcb.png)

Данная ошибка вызвана тем что **Docker** контейнеры изначально не 
имеют доступа к экрану (или любым другим ресурсам хост-системы) 
из-за принципов безопасности и изоляции, которые лежат в основе технологии контейнеров.

В случае с доступом к экрану это означает, что приложения внутри контейнера Docker не могут взаимодействовать с графическим интерфейсом пользователя хост-системы без явного разрешения. Это полезно для безопасности, но может вызвать сложности, если вам нужно запустить графическое приложение внутри контейнера.


### Screen sharing

Однако есть способы обойти вышеупомянутое ограничение.
Например, вы можете использовать `X11 forwarding`,
чтобы позволить приложениям внутри контейнера Docker взаимодействовать с сервером **X11** на хост-системе.
Это позволит приложениям отображать графический интерфейс пользователя на экране хост-системы.

---
#### Примечание 

**X11**, также известный как X Window System, — это система оконного интерфейса, которая обеспечивает стандартные инструменты и протоколы для создания графического пользовательского интерфейса в Unix и Unix-подобных ОС.

---

#### Linux 

Перед зппуском необходимо выполнить команду:

```bash
xhost +
```

Для запуска Docker c доступом к графическим ресурсам выполним команду:

```bash
docker run -it --privileged -e DISPLAY=$DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix:rw -e LIBGL_ALWAYS_SOFTWARE=0 \
--user=$(id -u $USER):$(id -g $USER)  px4_sim 
```

В данном случае будут запускаться симулятор Gazebo и любые другие программы с GUI. Рассмотрим аргументы:

* `--privileged`: этот флаг даёт контейнеру дополнительные привилегии. В частности, позволяет контейнеру получить доступ ко всем устройствам на хост-системе и выполнять некоторые операции, которые обычно не разрешены для контейнеров Docker.


*  `-e DISPLAY=$DISPLAY`: этот параметр устанавливает переменную окружения DISPLAY внутри контейнера. Это необходимо для X11 forwarding, которое позволяет приложениям внутри контейнера отображать графический интерфейс на экране хост-системы.


* `-v /tmp/.X11-unix:/tmp/.X11-unix:rw`: этот параметр говорит Docker создать том, который связывает директорию /tmp/.X11-unix на хост-системе с той же директорией внутри контейнера. Это необходимо для работы X11 forwarding.


* `-e LIBGL_ALWAYS_SOFTWARE=0`: тот параметр устанавливает переменную окружения LIBGL_ALWAYS_SOFTWARE внутри контейнера. Она необходима для некоторых графических приложений, которые используют библиотеку OpenGL, в частности **Gazebo**.


*  `--user=$(id -u $USER):$(id -g $USER)`: этот параметр говорит Docker запустить процесс внутри контейнера под определённым пользователем и группой на хост-системе. Это может быть полезно для обеспечения безопасности и предотвращения проблем с правами доступа.


#### Macos

Для использования графики на macos потребуется установить X11-сервер XQuartz

```bash
brew cask install xquartz
```

Затем необходимо выполнить команду
```bash
xhost + <hostname>
```

например:
```bash
xhost + 127.0.0.1
```

Для запуска контейнера выполняем команду:

```bash
docker run -it --rm -e DISPLAY=127.0.0.1:0 -e XAUTHORITY=/.Xauthority \
-v /tmp/.X11-unix:/tmp/.X11-unix -v ~/.Xauthority:/.Xauthority px4_sim
```

Настройка GUI для [Windows](https://medium.com/@potatowagon/how-to-use-gui-apps-in-linux-docker-container-from-windows-host-485d3e1c64a3)



### Volume

**Docker Volume** — это механизм, который позволяет сохранять и управлять данными, генерируемыми и используемыми контейнерами Docker. Представляет собой область на хост-системе или удалённом сервере, которая может быть подключена к одному или нескольким контейнерам, позволяя им читать и записывать данные в эту область.



Чтобы использовать Docker Volume, вы можете создать новый том с помощью команды docker volume create, а затем подключить его к контейнеру с помощью флага -v или --mount при запуске контейнера. Пример:

```bash
docker run -v my-volume:/path/in/container my-image
```

**Ключевая особенность Docker** — удаление всех файлов и данных после завершения сеанса. Docker Volume позволяет сохранять данные между сеансами работы с контейнером. Это может быть полезно при отладке, поскольку вы можете сохранять состояние вашего приложения или данные для анализа между запусками контейнера.

Теперь запустим наш контейнер с доступом к текущему репозиторию через volume

```bash
docker run -it --privileged -e DISPLAY=$DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix:rw -e LIBGL_ALWAYS_SOFTWARE=0 \
--user=$(id -u $USER):$(id -g $USER) -v $(pwd):/docker/home/src/my_pack px4_sim 
```

Если все пути описаны верно вы сможете использовать ваш volume в docker.

## Docker and VScode

Для работы и отладки ПО в контейнере вам понадобиться установить `Dev Container` plugin в VsCode:
![dev_containers_code](../.imgs/dev_containers_code.png)

Инструкцию по работе с плагином можно найти [тут](https://code.visualstudio.com/docs/devcontainers/containers#_quick-start-open-an-existing-folder-in-a-containerы) 

Для использования Docker с VS Code необходимо запустить наш контейнер следующим образом:

```bash 
docker run -it --privileged -e DISPLAY=$DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix:rw -e LIBGL_ALWAYS_SOFTWARE=0 \
--user=$(id -u $USER):$(id -g $USER)  -p 127.0.0.1:8080:8080 \
-v "$HOME/.vscode:/root/.vscode" -v "$PWD:/workspace"  -v $(pwd):/docker/home/src/my_pack px4_sim 
```

В VS Code необходимо нажать клавишу F1, далее выбрать следующий пункт:

![run_on_vscode_1](../.imgs/run_on_vscode_1.png)

После выбираем нужный нам контейнер и работаем в новом появившемся окне VS Code.

![run_on_vscode_2](../.imgs/run_on_vscode_2.png)


# Запуск контейнера для работы с проектом

Помимо этого можно использовать уже заранее собранный контейнер из gitlab.
Для этого потребуется войти в соответствующий registry:

```bash
docker login registry.gitlab.com
```

Далее запустим контейнер из папки scripts:

```bash
./start_sim_docker.sh -c registry.gitlab.com/drone-programming/skillbox/module_5/px4_simulation:latest
```

Для запуска контейнера с GPU потребуется добавить дополнительный флаг **-u** :

```bash
./start_sim_docker.sh -c registry.gitlab.com/drone-programming/skillbox/module_5/px4_simulation:latest -u 1
```

---

Данный вариант является наиболее предпочтительным, так как не требует сборки контейнера.

---